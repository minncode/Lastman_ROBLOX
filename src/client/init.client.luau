-- Last Man Standing í´ë¼ì´ì–¸íŠ¸
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local player = Players.LocalPlayer

-- ë§¤ë‹ˆì €ë“¤ ë¡œë“œ
local CharacterManager = require(ReplicatedStorage.Shared.CharacterManager)
local CameraSystem = require(script.Parent.CameraSystem)
local UISystem = require(script.Parent.UISystem)

-- ë§¤ë‹ˆì € ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
local characterManager = CharacterManager.new()
local cameraSystem = CameraSystem.new()
local uiSystem = UISystem.new()

print("Last Man Standing í´ë¼ì´ì–¸íŠ¸ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!")

-- í”Œë ˆì´ì–´ ìºë¦­í„° ì„¤ì •
characterManager:setupPlayer(player)

-- ìºë¦­í„° ìŠ¤í° ì‹œ ì¹´ë©”ë¼ ì‹œìŠ¤í…œ í™œì„±í™”
player.CharacterAdded:Connect(function(character)
    character:WaitForChild("Humanoid")
    wait(0.5) -- ìºë¦­í„° ë¡œë“œ ëŒ€ê¸°
    cameraSystem:enable()
end)

-- ì´ë¯¸ ìºë¦­í„°ê°€ ìˆë‹¤ë©´ ë°”ë¡œ í™œì„±í™”
if player.Character and player.Character:FindFirstChild("Humanoid") then
    cameraSystem:enable()
end

-- ì…ë ¥ ì²˜ë¦¬
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    
    characterManager:handleInput(player, input)
end)

UserInputService.InputEnded:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    
    characterManager:handleInput(player, input)
end)

-- RemoteEvent ì—°ê²° ëŒ€ê¸°
spawn(function()
    local remoteEvents = ReplicatedStorage:WaitForChild("RemoteEvents")
    
    -- ê²Œì„ ìƒíƒœ ë³€ê²½ ì´ë²¤íŠ¸
    local gameStateChanged = remoteEvents:WaitForChild("GameStateChanged")
    gameStateChanged.OnClientEvent:Connect(function(newState, data)
        print("ê²Œì„ ìƒíƒœ:", newState)
        
        -- ê²Œì„ ìƒíƒœì— ë”°ë¥¸ ì¹´ë©”ë¼ ì²˜ë¦¬
        if newState == "PLAYING" then
            if not cameraSystem:isEnabled() then
                cameraSystem:enable()
            end
            uiSystem:showGameStateMessage("ê²Œì„ ì‹œì‘!", "ë§ˆì§€ë§‰ê¹Œì§€ ì‚´ì•„ë‚¨ìœ¼ì„¸ìš”!", 3)
        elseif newState == "STARTING" then
            uiSystem:showGameStateMessage("ê²Œì„ ì‹œì‘ ì¤€ë¹„ ì¤‘...", "ì ì‹œ í›„ ê²Œì„ì´ ì‹œì‘ë©ë‹ˆë‹¤", 0)
        elseif newState == "WAITING" then
            uiSystem:hideGameStateMessage()
        elseif newState == "ENDING" then
            -- ê²Œì„ ì¢…ë£Œ ì‹œ ì¹´ë©”ë¼ í”ë“¤ë¦¼ íš¨ê³¼
            cameraSystem:shakCamera(2, 1)
        end
        
        -- UI ì—…ë°ì´íŠ¸ (ê²Œì„ ì •ë³´ ê°±ì‹ )
        spawn(function()
            local gameInfo = getGameInfo:InvokeServer()
            if gameInfo then
                uiSystem:updateGameInfo(newState, gameInfo.alivePlayers, #gameInfo.aliveAI)
                uiSystem:updatePlayerStatus(gameInfo.playerData)
            end
        end)
    end)
    
    -- í”Œë ˆì´ì–´ íƒˆë½ ì´ë²¤íŠ¸
    local playerEliminated = remoteEvents:WaitForChild("PlayerEliminated")
    playerEliminated.OnClientEvent:Connect(function(eliminatedPlayer, reason)
        print("í”Œë ˆì´ì–´ íƒˆë½:", eliminatedPlayer.Name, "-", reason)
        
        -- íƒˆë½ ì•Œë¦¼ í‘œì‹œ
        if eliminatedPlayer == player then
            uiSystem:showNotification("ë‹¹ì‹ ì´ íƒˆë½í–ˆìŠµë‹ˆë‹¤: " .. reason, 5, uiSystem.UI_CONFIG.COLORS.DANGER)
            uiSystem:showGameStateMessage("íƒˆë½!", reason, 3)
        else
            uiSystem:showNotification(eliminatedPlayer.Name .. " íƒˆë½: " .. reason, 3, uiSystem.UI_CONFIG.COLORS.WARNING)
        end
        
        -- UI ì •ë³´ ì—…ë°ì´íŠ¸
        spawn(function()
            local gameInfo = getGameInfo:InvokeServer()
            if gameInfo then
                uiSystem:updateGameInfo(gameInfo.gameState, gameInfo.alivePlayers, #gameInfo.aliveAI)
            end
        end)
    end)
    
    -- ê²Œì„ ì¢…ë£Œ ì´ë²¤íŠ¸
    local gameEnded = remoteEvents:WaitForChild("GameEnded")
    gameEnded.OnClientEvent:Connect(function(reason, winner)
        print("ê²Œì„ ì¢…ë£Œ:", reason)
        
        -- ê²Œì„ ê²°ê³¼ í‘œì‹œ
        if reason:find("ìŠ¹ë¦¬") then
            local winnerName = reason:match("ìŠ¹ë¦¬: (.+)") or "ì•Œ ìˆ˜ ì—†ìŒ"
            if winnerName == player.Name then
                uiSystem:showGameStateMessage("ìŠ¹ë¦¬!", "ì¶•í•˜í•©ë‹ˆë‹¤!", 5)
                uiSystem:showNotification("ğŸ‰ ìŠ¹ë¦¬í–ˆìŠµë‹ˆë‹¤! ğŸ‰", 5, uiSystem.UI_CONFIG.COLORS.SUCCESS)
            else
                uiSystem:showGameStateMessage("ê²Œì„ ì¢…ë£Œ", winnerName .. " ìŠ¹ë¦¬", 5)
                uiSystem:showNotification("ê²Œì„ ì¢…ë£Œ: " .. reason, 5, uiSystem.UI_CONFIG.COLORS.WARNING)
            end
        else
            uiSystem:showGameStateMessage("ê²Œì„ ì¢…ë£Œ", reason, 5)
            uiSystem:showNotification("ê²Œì„ ì¢…ë£Œ: " .. reason, 5, uiSystem.UI_CONFIG.COLORS.WARNING)
        end
    end)
    
    -- ê²Œì„ ì •ë³´ ìš”ì²­ í•¨ìˆ˜ (ë‹¤ë¥¸ ì´ë²¤íŠ¸ì—ì„œ ì‚¬ìš©)
    local getGameInfo = remoteEvents:WaitForChild("GetGameInfo")
    
    -- ì£¼ê¸°ì ìœ¼ë¡œ UI ì—…ë°ì´íŠ¸
    spawn(function()
        while true do
            wait(1) -- 1ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸
            
            local success, gameInfo = pcall(function()
                return getGameInfo:InvokeServer()
            end)
            
            if success and gameInfo then
                uiSystem:updateGameInfo(gameInfo.gameState, gameInfo.alivePlayers, #gameInfo.aliveAI)
                uiSystem:updatePlayerStatus(gameInfo.playerData)
            end
        end
    end)
end)